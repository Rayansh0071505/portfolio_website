name: Infrastructure Management

on:
  workflow_dispatch:  # Only manual trigger, never automatic
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'plan'
        type: choice
        options:
          - plan
          - apply
          - destroy

jobs:
  terraform:
    name: Terraform
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.5.0

      - name: Create terraform.tfvars
        run: |
          cat > terraform/terraform.tfvars << 'EOF'
          aws_region  = "us-east-1"
          environment = "production"
          project_name = "rayansh_portfolio"
          instance_type = "t3.micro"
          key_pair_name = "demo"
          instance_root_volume_size = 30
          vpc_cidr = "10.0.0.0/16"
          public_subnet_cidr = "10.0.1.0/24"
          private_subnet_cidr = "10.0.2.0/24"
          bucket_prefix = "rayansh_portfolio"
          enable_versioning = true
          cloudfront_enabled = true
          custom_domain = ""
          backend_port = 8080
          docker_image = "ACCOUNT_ID.dkr.ecr.us-east-1.amazonaws.com/rayansh_portfolio:latest"
          cloudfront_secret = "CLOUDFRONT_SECRET_FROM_GITHUB"
          allowed_origins = []
          EOF

          # Replace placeholders with actual values
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          sed -i "s|ACCOUNT_ID|$ACCOUNT_ID|g" terraform/terraform.tfvars
          sed -i "s|CLOUDFRONT_SECRET_FROM_GITHUB|${{ secrets.CLOUDFRONT_SECRET }}|g" terraform/terraform.tfvars

      - name: Initialize Terraform
        working-directory: terraform
        run: |
          terraform init \
            -backend-config="bucket=$TERRAFORM_BUCKET" \
            -backend-config="key=infrastructure.tfstate" \
            -backend-config="region=us-east-1" \
            -backend-config="encrypt=true"
        env:
          TERRAFORM_BUCKET: ${{ secrets.TERRAFORM_STATE_BUCKET }}

      - name: Validate Terraform
        working-directory: terraform
        run: terraform validate

      - name: Terraform Plan
        working-directory: terraform
        run: |
          terraform plan -out=tfplan -no-color
        env:
          TF_INPUT: false

      - name: Save Terraform Plan
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan
          path: terraform/tfplan

      - name: Apply Terraform
        if: github.event_name == 'push' && github.ref == 'refs/heads/master' || github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'apply'
        working-directory: terraform
        run: |
          terraform apply -auto-approve tfplan
        env:
          TF_INPUT: false

      - name: Get Terraform Outputs
        if: success()
        working-directory: terraform
        run: |
          echo "## Infrastructure Outputs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Backend" >> $GITHUB_STEP_SUMMARY
          echo "- Public IP: $(terraform output -raw backend_public_ip)" >> $GITHUB_STEP_SUMMARY
          echo "- Instance ID: $(terraform output -raw backend_instance_id)" >> $GITHUB_STEP_SUMMARY
          echo "- API Endpoint: $(terraform output -raw backend_api_endpoint)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Frontend S3" >> $GITHUB_STEP_SUMMARY
          echo "- Bucket: $(terraform output -raw frontend_bucket_name)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### CloudFront" >> $GITHUB_STEP_SUMMARY
          echo "- Domain: $(terraform output -raw cloudfront_domain_name)" >> $GITHUB_STEP_SUMMARY
          echo "- Distribution ID: $(terraform output -raw cloudfront_distribution_id)" >> $GITHUB_STEP_SUMMARY

      - name: Save Outputs
        if: success()
        working-directory: terraform
        run: |
          terraform output -json > outputs.json
        env:
          TF_INPUT: false

      - name: Upload Outputs
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: terraform-outputs
          path: terraform/outputs.json

      - name: Store Infrastructure Info
        if: success()
        run: |
          mkdir -p infrastructure-info
          cd terraform
          echo "Backend IP: $(terraform output -raw backend_public_ip)" > ../infrastructure-info/info.txt
          echo "CloudFront Domain: $(terraform output -raw cloudfront_domain_name)" >> ../infrastructure-info/info.txt
          echo "Deployment successful at $(date)" >> ../infrastructure-info/info.txt

      - name: Upload Infrastructure Info
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: infrastructure-info
          path: infrastructure-info/

  notify:
    name: Notify Deployment
    runs-on: ubuntu-latest
    needs: terraform
    if: always()

    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4

      - name: Prepare Summary
        run: |
          if [ -f "infrastructure-info/info.txt" ]; then
            echo "## ✅ Infrastructure Deployment Successful" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            cat infrastructure-info/info.txt >> $GITHUB_STEP_SUMMARY
          else
            echo "## ⚠️ Infrastructure Deployment Status" >> $GITHUB_STEP_SUMMARY
            echo "Check logs for details" >> $GITHUB_STEP_SUMMARY
          fi
