name: Deploy Frontend and Backend

on:
  push:
    branches:
      - master
      - main
    paths:
      - 'project/**'
      - 'backend/**'
      - 'Dockerfile'
      - 'docker-compose.yml'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:

jobs:
  # Job 1: Build and Push Docker Image to ECR
  build-docker:
    name: Build Docker Image
    runs-on: ubuntu-latest
    outputs:
      image-uri: ${{ steps.image.outputs.image-uri }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ steps.login-ecr.outputs.registry }}/rayansh_portfolio:latest
            ${{ steps.login-ecr.outputs.registry }}/rayansh_portfolio:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Output image URI
        id: image
        run: |
          REGISTRY="${{ steps.login-ecr.outputs.registry }}"
          IMAGE_URI="$REGISTRY/rayansh_portfolio:${{ github.sha }}"
          echo "image-uri=$IMAGE_URI" >> $GITHUB_OUTPUT

  # Job 2: Get CloudFront Domain
  get-cloudfront-domain:
    name: Get CloudFront Domain from Terraform
    runs-on: ubuntu-latest
    outputs:
      cloudfront-domain: ${{ steps.get-domain.outputs.domain }}
      cloudfront-id: ${{ steps.get-id.outputs.id }}
      s3-bucket: ${{ steps.get-bucket.outputs.bucket }}

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Get CloudFront Domain
        id: get-domain
        run: |
          DOMAIN=$(aws cloudfront list-distributions --query 'DistributionList.Items[?contains(Comment, `rayansh`) && contains(Comment, `portfolio`)].DomainName' --output text | head -1)
          echo "domain=$DOMAIN" >> $GITHUB_OUTPUT
          echo "CloudFront Domain: $DOMAIN"

      - name: Get Distribution ID
        id: get-id
        run: |
          ID=$(aws cloudfront list-distributions --query 'DistributionList.Items[?contains(Comment, `rayansh`) && contains(Comment, `portfolio`)].Id' --output text | head -1)
          echo "id=$ID" >> $GITHUB_OUTPUT
          echo "Distribution ID: $ID"

      - name: Get S3 Bucket
        id: get-bucket
        run: |
          BUCKET=$(aws s3 ls | grep rayansh-portfolio-frontend | awk '{print $3}')
          echo "bucket=$BUCKET" >> $GITHUB_OUTPUT
          echo "S3 Bucket: $BUCKET"

  # Job 3: Deploy Frontend to S3
  deploy-frontend:
    name: Deploy Frontend to S3
    runs-on: ubuntu-latest
    needs: get-cloudfront-domain

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Build frontend
        run: |
          cd project
          npm install --legacy-peer-deps
          npm run build
        env:
          VITE_API_URL: https://${{ needs.get-cloudfront-domain.outputs.cloudfront-domain }}/api
          REACT_APP_API_URL: https://${{ needs.get-cloudfront-domain.outputs.cloudfront-domain }}/api

      - name: Deploy to S3
        run: |
          aws s3 sync project/dist s3://${{ needs.get-cloudfront-domain.outputs.s3-bucket }}/ \
            --delete \
            --cache-control "public, max-age=3600" \
            --exclude "index.html" \
            --exclude "*.html"

          aws s3 sync project/dist s3://${{ needs.get-cloudfront-domain.outputs.s3-bucket }}/ \
            --cache-control "public, max-age=0, must-revalidate" \
            --include "index.html" \
            --include "*.html"

      - name: Invalidate CloudFront
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ needs.get-cloudfront-domain.outputs.cloudfront-id }} \
            --paths "/*"

      - name: Frontend deployment summary
        run: echo "‚úÖ Frontend deployed to https://${{ needs.get-cloudfront-domain.outputs.cloudfront-domain }}"

  # Job 4: Deploy Backend to EC2
  deploy-backend:
    name: Deploy Backend to EC2
    runs-on: ubuntu-latest
    needs: build-docker

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Get deployment info
        id: get-info
        run: |
          EC2_IP=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=rayansh_portfolio-backend" \
            --query 'Reservations[0].Instances[0].PublicIpAddress' \
            --output text)
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          echo "ec2-ip=$EC2_IP" >> $GITHUB_OUTPUT
          echo "account-id=$ACCOUNT_ID" >> $GITHUB_OUTPUT
          echo "Backend IP: $EC2_IP"
          echo "Account ID: $ACCOUNT_ID"

      - name: Deploy with SSH
        uses: appleboy/ssh-action@master
        env:
          ACCOUNT_ID: ${{ steps.get-info.outputs.account-id }}
        with:
          host: ${{ steps.get-info.outputs.ec2-ip }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          command_timeout: 10m
          envs: ACCOUNT_ID
          script: |
            set -e

            # Quick connectivity test
            echo "Testing internet connectivity..."
            timeout 5 curl -s https://aws.amazon.com > /dev/null || {
              echo "‚ùå No internet connectivity!"
              exit 1
            }
            echo "‚úÖ Internet OK"

            # Create directory if it doesn't exist
            sudo mkdir -p /opt/backend
            cd /opt/backend
            sudo chown -R ec2-user:ec2-user /opt/backend

            # Check if .env exists, only fetch if missing
            if [ ! -f .env ]; then
              echo "Fetching .env from Parameter Store (first time)..."
              timeout 10 aws ssm get-parameter --name "/rayansh_portfolio/env" --region us-east-1 --query 'Parameter.Value' --output text > .env 2>&1 || {
                echo "‚ùå Failed to fetch .env"
                exit 1
              }
            else
              echo "‚úÖ .env already exists ($(wc -c < .env) bytes) - skipping fetch"
            fi

            # Use AWS account ID passed from GitHub Actions
            echo "Using AWS account ID: ${ACCOUNT_ID}"
            IMAGE_NAME="${ACCOUNT_ID}.dkr.ecr.us-east-1.amazonaws.com/rayansh_portfolio:latest"
            echo "‚úÖ Image: ${IMAGE_NAME}"

            # Check if image exists locally
            if docker image inspect ${IMAGE_NAME} >/dev/null 2>&1; then
              echo "‚úÖ Image already exists locally"

              # Try to pull latest (but don't fail if it doesn't work)
              echo "Attempting to pull latest image..."
              timeout 60 docker pull ${IMAGE_NAME} 2>&1 && echo "‚úÖ Pulled latest image" || echo "‚ö†Ô∏è Using existing image (pull failed)"
            else
              echo "‚ùå Image not found locally and cannot pull (AWS CLI not available)"
              echo "This is a new instance - need to wait for user_data to complete AWS CLI setup"
              exit 1
            fi

            # Stop existing container
            docker stop backend_api 2>/dev/null || true
            docker rm backend_api 2>/dev/null || true

            # Start Backend with CloudWatch logging
            docker run -d \
              --name backend_api \
              -p 8080:8080 \
              -e PYTHONUNBUFFERED=1 \
              --env-file /opt/backend/.env \
              -v /data:/app/data \
              --restart unless-stopped \
              --log-driver=awslogs \
              --log-opt awslogs-region=us-east-1 \
              --log-opt awslogs-group=/rayansh_portfolio/backend \
              --log-opt awslogs-stream=backend_api \
              --log-opt awslogs-create-group=true \
              ${IMAGE_NAME}

            # Wait for backend to be ready (max 60 seconds)
            echo "Waiting for backend to start..."
            for i in {1..30}; do
              if curl -f http://localhost:8080/ 2>/dev/null; then
                echo "Backend is ready!"
                exit 0
              fi
              echo "Attempt $i/30: Backend not ready yet, waiting..."
              sleep 2
            done

            # If we get here, backend didn't start
            echo "Backend failed to start after 60 seconds"
            echo "Container logs:"
            docker logs backend_api --tail 50
            exit 1

      - name: Backend deployment summary
        run: |
          echo "Backend deployed successfully"

  # Job 5: Verify Deployment
  verify:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: [deploy-frontend, deploy-backend, get-cloudfront-domain]
    if: success()

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Verify Frontend
        run: |
          DOMAIN=${{ needs.get-cloudfront-domain.outputs.cloudfront-domain }}
          echo "‚úÖ Frontend: https://$DOMAIN"
          curl -I https://$DOMAIN | head -5 || true

      - name: Verify Backend Health
        run: |
          EC2_IP=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=rayansh_portfolio-backend" \
            --query 'Reservations[0].Instances[0].PublicIpAddress' \
            --output text)
          echo "‚úÖ Backend: http://$EC2_IP:8080"
          curl -I http://$EC2_IP:8080/ | head -5 || true

      - name: Deployment Summary
        run: |
          echo "üéâ Deployment complete!"
          echo "Frontend: https://${{ needs.get-cloudfront-domain.outputs.cloudfront-domain }}"
          echo "Backend API: https://${{ needs.get-cloudfront-domain.outputs.cloudfront-domain }}/api/chat"
